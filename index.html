<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>WebGIS Infrastruktur Desa</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-search@2.9.8/dist/leaflet-search.min.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; }
        header {
            background: #3a86ff;
            color: white;
            padding: 1rem;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        nav {
            background: #264653;
            padding: 0.5rem;
            display: flex;
            gap: 1rem;
            justify-content: center;
        }
        nav a {
            color: white;
            text-decoration: none;
            padding: 0.5rem 1rem;
            background: #457b9d;
            border-radius: 5px;
        }
        nav a:hover {
            background: #2a9d8f;
        }
        #map {
            height: calc(100vh - 130px);
            width: 100%;
        }
        footer {
            text-align: center;
            padding: 1rem;
            background: #eee;
        }
    </style>
</head>
<body>

<header>
    <h2>WebGIS Infrastruktur Desa Purwosari Baru</h2>
</header>

<nav>
    <a href="data-lokasi.html">Data Lokasi</a>
    <a href="index.html">Peta Kondisi Infrastruktur</a>
    <a href="config.html">Peta Digital</a>
</nav>

<div id="map"></div>

<footer>&copy; 2025 Pemerintah Desa Purwosari Baru</footer>

<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
<script src="https://unpkg.com/leaflet-search@2.9.8/dist/leaflet-search.src.js"></script>

<script>
    var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    });

    var osmHot = L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors, Tiles style by Humanitarian OpenStreetMap Team'
    });

    var stadiaOutdoors = L.tileLayer('https://tiles.stadiamaps.com/tiles/outdoors/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://stadiamaps.com/">Stadia Maps</a>, &copy; <a href="https://openmaptiles.org/">OpenMapTiles</a> &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors'
    });

    var esriSatellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Tiles &copy; Esri'
    });
    
    var topografi = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
        attribution: 'Map data: &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, <a href="http://viewfinderpanoramas.org">SRTM</a> | Map style: &copy; <a href="https://opentopomap.org">OpenTopoMap</a> (<a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-SA</a>)'
    });

    var map = L.map('map').setView([-3.3476300515425685, 114.47057026684308], 15);
    osm.addTo(map);

    const baseLayers = {
        'OpenStreetMap': osm,
        'Humanitarian OSM': osmHot,
        'Outdoors (Stadia)': stadiaOutdoors,
        'Satellite (Esri)': esriSatellite,
        'Topografi': topografi
    };

    var kelompokLayer = {
        Baik: L.layerGroup(),
        Sedang: L.layerGroup(),
        Rusak_Ringan: L.layerGroup(),
        Rusak_Berat: L.layerGroup(),
        Tidak_layak: L.layerGroup()
    };

    // Tambahkan semua layer group ke map
    for (var key in kelompokLayer) {
        kelompokLayer[key].addTo(map);
    }

    var geojsonLayer = L.geoJSON(null, {
    onEachFeature: function (feature, layer) {
        
    var props = feature.properties;
       const namaFile = props.nama.toLowerCase()
        .replace(/ /g, '_')
        .replace(/[^\w-]/g, '') + '.jpg';
    const fotoUrl = `img/${namaFile}`;      
   //const timestamp = new Date().getTime();
   // const fotoUrl = `${props.foto}?t=${timestamp}`;
   // const defaultImg = 'img/default.jpg';
    
    // Buat elemen img terpisah untuk kontrol lebih baik
    const imgElement = document.createElement('img');
    imgElement.src = fotoUrl;
    imgElement.style.maxWidth = '100%';
    imgElement.style.maxHeight = '150px';
    imgElement.style.borderRadius = '4px';
    imgElement.alt = `Foto ${props.nama}`;
    
    // Fungsi untuk handle error
    imgElement.onerror = function() {
        this.src = 'img/default.jpg';
        console.error(`Gagal memuat: ${fotoUrl}`);
    };
    
    // Buat div container untuk gambar
    const imgContainer = document.createElement('div');
    imgContainer.style.marginTop = '10px';
    imgContainer.style.textAlign = 'center';
    imgContainer.style.minHeight = '150px';
    imgContainer.appendChild(imgElement);
    
    // Buat konten popup
    const popupContent = document.createElement('div');
    popupContent.style.maxWidth = '300px';
    popupContent.innerHTML = `
        <h4 style="margin-bottom: 5px;">${props.nama}</h4>
        <p><strong>Kondisi:</strong> ${props.kondisi}</p>
        <p><strong>Alamat:</strong> ${props.alamat}</p>
    `;
    popupContent.appendChild(imgContainer);
    
    // Debugging intensif
    console.log(`Mencoba memuat gambar: ${fotoUrl}`);
    fetch(fotoUrl)
        .then(response => {
            if (!response.ok) {
                console.warn(`Gambar tidak ditemukan (${response.status}): ${fotoUrl}`);
            } else {
                console.log(`Gambar berhasil ditemukan: ${fotoUrl}`);
            }
        })
        .catch(error => console.error(`Error saat memeriksa gambar: ${fotoUrl}`, error));
    
    layer.bindPopup(popupContent);
    
    // Debugging
    fetch(fotoUrl)
        .then(response => {
            if (!response.ok) {
                console.warn(`Gambar tidak ditemukan: ${fotoUrl}`);
            }
        });
    var kondisi = props.kondisi.replace(/\s+/g, '_');
    if (kelompokLayer[kondisi]) {
        kelompokLayer[kondisi].addLayer(layer);
    }
},

        
        pointToLayer: function(feature, latlng) {
            var color;
            switch(feature.properties.kondisi) {
                case 'Baik': color = 'green'; break;
                case 'Sedang': color = 'orange'; break;
                case 'Rusak Ringan': color = 'gold'; break;
                case 'Rusak Berat': color = 'goldenrod'; break;
                case 'Tidak layak': color = 'red'; break;
                default: color = 'blue';
            }

            return L.circleMarker(latlng, {
                radius: 8,
                fillColor: color,
                color: '#000',
                weight: 1,
                opacity: 1,
                fillOpacity: 0.8
            });
        }
    });

    fetch('data.php')
        .then(res => res.json())
        .then(data => {
            console.log("Data diterima:", data);
            geojsonLayer.addData(data);
            
            // Debug path gambar
            data.features.forEach(f => {
                const fotoPath = `img/${f.properties.id}.jpg`;
                console.log(`Mencoba mengakses: ${fotoPath}`);
                fetch(fotoPath)
                    .then(r => console.log(`Status gambar ${fotoPath}:`, r.ok ? "OK" : "Tidak ditemukan"))
                    .catch(e => console.error("Error:", e));
            });
        })
        .catch(err => {
            console.error('Error loading data:', err);
            alert("Gagal memuat data. Lihat konsol untuk detail.");
        });
        
    L.Control.geocoder().addTo(map);

    var searchControl = new L.Control.Search({
        layer: geojsonLayer,
        propertyName: 'nama',
        marker: false,
        moveToLocation: function(latlng, map) {
            map.setView(latlng, 17);
        }
    });
    map.addControl(searchControl);

    L.control.layers(baseLayers, kelompokLayer).addTo(map);
    L.control.scale().addTo(map);

 // Tambahkan kode ini setelah inisialisasi peta
    const watermark = L.control({position: 'bottomleft'});

        watermark.onAdd = function(map) {
        const div = L.DomUtil.create('div', 'arahangin');
        div.innerHTML = '<img src="png/arahangin.png" style="width:120px; height:auto; opacity:0.7;">';
        return div;
    };

    watermark.addTo(map);

// Buat control panel
    const infoPanel = L.control({position: 'bottomright'});

    infoPanel.onAdd = function(map) {
        this._div = L.DomUtil.create('div', 'info-panel');
        this.update();
        return this._div;
    };

    infoPanel.update = function(props) {
        this._div.innerHTML = `
            <img src="png/purwosaribaru.png" style="width:100%; max-width:150px; margin:5px 0;">
            <h4>Desa Purwosari Baru</h4>
            <p>Selamat datang di peta Kondisi infrastruktur desa</p>
            <p>Kondisi Infrastruktur dibagi menjadi 5 kategori</p>
            <p>Hijau        = Baik</p>
            <p>orange       = sedang</p>
            <p>kuning       = rusak ringan</p>
            <p>kuning gelap = rusak berat</p>
            <p>Merah        = Tidak Layak</p>
        `;
    };

    infoPanel.addTo(map);
</script>

</body>
</html>